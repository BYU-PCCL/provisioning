- name: ssh
  hosts: all
  gather_facts: no
  tags:
    - bootstrap
    - ssh
  vars:
    - ssh_key_file: .ssh/id_rsa
    - remote_sudoers:
        - user: remote
          # python3 -c 'import crypt; print(crypt.crypt("the password"))'
          password: foEY7SALC7m46
  tasks:
    - name: ssh | Create 'sudo' group
      group:
        name: sudo
        state: present
      become: yes

    - name: ssh | Allow 'sudo' group to have sudo
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%sudo'
        line: '%sudo ALL=(ALL:ALL) ALL'
        validate: visudo -cf %s
      become: yes

    - name: ssh | Create user and add to sudo group
      user:
        name: "{{ item.user }}"
        state: present
        password: "{{ item.password }}"
        update_password: on_create
        generate_ssh_key: no
        groups: sudo
        append: yes
      with_items: "{{ remote_sudoers }}"
      become: yes

    - name: ssh | Create new ssh key-pair on localhost
      user:
        name: "{{ lookup('env', 'USER') }}"
        generate_ssh_key: yes
        ssh_key_bits: 2048
        ssh_key_file: "{{ ssh_key_file }}"
      delegate_to: localhost
      become: no

    - name: ssh | Upload new public ssh key
      authorized_key:
        user: "{{ item.user }}"
        key: "{{ lookup('file', lookup('env','HOME') + '/' + ssh_key_file + '.pub') }}"
        manage_dir: yes
      with_items: "{{ remote_sudoers }}"
      become: yes

  # TODO: modify ~/.ssh/config and add all PCCL hosts
